//==============================
// ÂàùÊúüË®≠ÂÆö
//==============================
const gameArea = document.getElementById("gameArea");
const player = document.getElementById("player");
const enemy = document.getElementById("enemy");
const result = document.getElementById("result");

let bgX = 0;
const playerX = 100;
let playerY = window.innerHeight / 2 - 50;
let enemyY = 100;
let enemySpeed = 2;
let bullets = [];
let isHit = false;
let gameStarted = false;
let gameCleared = false;
let goalReached = false;

//==============================
// ÂΩì„Åü„ÇäÂà§ÂÆö„Éù„É™„Ç¥„É≥„Éá„Éº„Çø(JSON)
//==============================
const hitboxData = {
  "free": [
    { "nx": 0.3, "ny": 0.2822916507720947 },
    { "nx": 0.35, "ny": 0.35729165077209474 },
    { "nx": 0.64375, "ny": 0.3760416507720947 },
    { "nx": 0.64375, "ny": 0.3447916507720947 },
    { "nx": 0.725, "ny": 0.3322916507720947 },
    { "nx": 0.7375, "ny": 0.3760416507720947 },
    { "nx": 0.8375, "ny": 0.36979165077209475 },
    { "nx": 0.8375, "ny": 0.6322916507720947 },
    { "nx": 0.475, "ny": 0.6385416507720947 },
    { "nx": 0.1875, "ny": 0.6322916507720947 },
    { "nx": 0.18125, "ny": 0.33854165077209475 },
    { "nx": 0.225, "ny": 0.3322916507720947 }
  ]
};

//==============================
// SATÊ≥ï„Å´„Çà„ÇãÂΩì„Åü„ÇäÂà§ÂÆö
//==============================
function getPolygonFromJSON(element, type) {
  const json = hitboxData[type];
  const rect = element.getBoundingClientRect();
  return json.map(p => ({
    x: rect.left + p.nx * rect.width,
    y: rect.top + p.ny * rect.height
  }));
}

function projectPolygon(polygon, axis) {
  const dots = polygon.map(p => (p.x * axis.x + p.y * axis.y));
  return [Math.min(...dots), Math.max(...dots)];
}

function polygonsCollide(polyA, polyB) {
  const polys = [polyA, polyB];
  for (let i = 0; i < polys.length; i++) {
    const polygon = polys[i];
    for (let j = 0; j < polygon.length; j++) {
      const k = (j + 1) % polygon.length;
      const edgeX = polygon[k].x - polygon[j].x;
      const edgeY = polygon[k].y - polygon[j].y;
      const normal = { x: -edgeY, y: edgeX };
      let [minA, maxA] = projectPolygon(polyA, normal);
      let [minB, maxB] = projectPolygon(polyB, normal);
      if (maxA < minB || maxB < minA) return false;
    }
  }
  return true;
}

//==============================
// Êïµ„ÅÆÂãï„Åç„ÉªÂºæ„ÅÆÂá¶ÁêÜ
//==============================
function moveEnemy() {
  enemyY += enemySpeed;
  if (enemyY <= 0 || enemyY >= window.innerHeight - 100) enemySpeed *= -1;
  enemy.style.top = enemyY + "px";
}

function shootBullet() {
  const bullet = document.createElement("img");
  bullet.src = "../image/bind.png";
  bullet.className = "bullet";
  gameArea.appendChild(bullet);
  const startWorldX = -bgX + enemy.offsetLeft;
  const startWorldY = enemyY + enemy.offsetHeight / 2 - 20;
  bullets.push({ element: bullet, worldX: startWorldX, worldY: startWorldY, speed: -15 });
}

function updateBullets() {
  bullets.forEach((b, index) => {
    b.worldX += b.speed;
    b.element.style.left = (b.worldX + bgX) + "px";
    b.element.style.top = b.worldY + "px";

    if (b.worldX + bgX < -50) {
      b.element.remove();
      bullets.splice(index, 1);
      return;
    }

    if (!isHit && !gameCleared) {
      const bulletRect = b.element.getBoundingClientRect();
      const bulletPoly = [
        {x: bulletRect.left, y: bulletRect.top},
        {x: bulletRect.right, y: bulletRect.top},
        {x: bulletRect.right, y: bulletRect.bottom},
        {x: bulletRect.left, y: bulletRect.bottom}
      ];
      const playerPoly = getPolygonFromJSON(player, "free");
      if (polygonsCollide(playerPoly, bulletPoly)) {
        handleHit();
        b.element.remove();
        bullets.splice(index, 1);
      }
    }
  });
}

//==============================
// Ë¢´ÂºæÂá¶ÁêÜ
//==============================
function handleHit() {
  isHit = true;
  result.style.left = player.offsetLeft + "px";
  result.style.top = player.offsetTop + "px";
  result.style.width = player.offsetWidth + "px";
  result.style.height = player.offsetHeight + "px";
  result.classList.add("shake");
  result.style.display = "block";
  player.style.display = "none";
  setTimeout(() => {
    result.style.display = "none";
    result.classList.remove("shake");
    player.style.display = "block";
    isHit = false;
  }, 1000);
}

//==============================
// ÂÖ•Âäõ„Éª„Éû„Ç¶„ÇπÂá¶ÁêÜ
//==============================
document.addEventListener("keydown", (e) => {
  if (e.key === "Shift") shootBullet();
  if (isHit || gameCleared) return;
  if (e.key === "ArrowUp") playerY -= 10;
  if (e.key === "ArrowDown") playerY += 10;
  if (e.key === "ArrowLeft") bgX += 10;
  if (e.key === "ArrowRight") bgX -= 10;
  playerY = Math.max(0, Math.min(window.innerHeight - player.offsetHeight, playerY));
  player.style.top = playerY + "px";
  gameArea.style.backgroundPosition = bgX + "px 0px";
});

let cursorX = window.innerWidth / 2;
let cursorY = window.innerHeight / 2;
document.addEventListener("mousemove", (e) => {
  cursorX = e.clientX;
  cursorY = e.clientY;
});

//==============================
// „Ç¥„Éº„É´Ë®≠ÂÆö
//==============================

const goal = document.createElement("img");
goal.src = "../image/goal.png";

goal.className = "sprite";
goal.style.display = "none";
goal.style.position = "absolute";
goal.style.top = "50%";
goal.style.left = "90%";
goal.style.transform = "translateY(-50%)";
goal.style.zIndex = "1";
goal.style.opacity = "1";
gameArea.appendChild(goal);

function updateGoalPosition() {
  goal.style.left = `${window.innerWidth - 200 + bgX}px`; 
}

//==============================
// „ÇØ„É™„Ç¢„ÉªÂãùÂà©„É°„ÉÉ„Çª„Éº„Ç∏
//==============================
const clearMessage = document.createElement("div");
clearMessage.style.position = "absolute";
clearMessage.style.top = "50%";
clearMessage.style.left = "50%";
clearMessage.style.transform = "translate(-50%, -50%)";
clearMessage.style.fontSize = "64px";
clearMessage.style.color = "yellow";
clearMessage.style.fontFamily = "monospace";
clearMessage.style.display = "none";
clearMessage.style.zIndex = "9999";
clearMessage.textContent = "üéâ ÂãùÂà©ÔºÅÔºÅ üéâ";
gameArea.appendChild(clearMessage);

//==============================
// „Çπ„ÇØ„É≠„Éº„É´Ë∑ùÈõ¢Ë°®Á§∫
//==============================
const scrollDisplay = document.createElement("div");
scrollDisplay.style.position = "absolute";
scrollDisplay.style.top = "20px";
scrollDisplay.style.right = "20px";
scrollDisplay.style.fontSize = "24px";
scrollDisplay.style.fontFamily = "monospace";
scrollDisplay.style.color = "red";
scrollDisplay.style.zIndex = "9999";
scrollDisplay.textContent = "Ë∑ùÈõ¢: 0 / 1000"; // ÂàùÊúüË°®Á§∫
gameArea.appendChild(scrollDisplay);

// „Ç¥„Éº„É´„Åæ„Åß„ÅÆË∑ùÈõ¢(pxÊèõÁÆó)
const goalDistance = 1000; 

let scrollCount = 0;
let prevBgX = bgX; // Ââç„Éï„É¨„Éº„É†„ÅÆbgX


//==============================
// „É°„Ç§„É≥„É´„Éº„Éó
//==============================
setInterval(() => {
  if (!gameStarted || gameCleared) return;

  moveEnemy();
  updateBullets();

  if (!isHit) {
    const playerCenterX = playerX + player.offsetWidth / 2;
    const playerCenterY = playerY + player.offsetHeight / 2;

    if (cursorY < playerCenterY - 5) playerY -= 5;
    if (cursorY > playerCenterY + 5) playerY += 5;
    playerY = Math.max(0, Math.min(window.innerHeight - player.offsetHeight, playerY));
    player.style.top = playerY + "px";

    if (cursorX > playerCenterX + 10) bgX -= 5; // Âè≥„Çπ„ÇØ„É≠„Éº„É´
    else if (cursorX < playerCenterX - 10) bgX += 5; // Â∑¶„Çπ„ÇØ„É≠„Éº„É´
    gameArea.style.backgroundPosition = bgX + "px 0px";

    // „Çπ„ÇØ„É≠„Éº„É´Èáè„ÅÆÊõ¥Êñ∞ÔºàÂ∑¶„Å´ÈÄ≤„ÇÄ„Å®Â¢ó„Åà„ÄÅÂè≥„Å´Êàª„Çã„Å®Ê∏õ„ÇãÔºâ
    let delta = prevBgX - bgX; 
    scrollCount += delta; 
    prevBgX = bgX;

    // Ë∑ùÈõ¢Ë°®Á§∫
    let distance = Math.max(0, Math.floor(scrollCount));
    distance = Math.min(distance, goalDistance); // „Ç¥„Éº„É´„ÇíË∂Ö„Åà„Å™„ÅÑ
    scrollDisplay.textContent = `Ë∑ùÈõ¢: ${distance} / ${goalDistance}`;

    // „Ç¥„Éº„É´Âà∞ÈÅîÂà§ÂÆöÔºà„Çπ„ÇØ„É≠„Éº„É´Ë∑ùÈõ¢„Éô„Éº„ÇπÔºâ
    if (distance >= goalDistance && !gameCleared) {
      gameCleared = true;
      clearMessage.style.display = "block";

      goal.style.display = "block";
      updateGoalPosition();
      goal.style.opacity = "0.4";
      goal.style.filter = "brightness(0.8)";
      console.log("üéâ „Ç¥„Éº„É´Âà∞ÈÅîÔºÅÂãùÂà©ÔºÅÔºÅ");
    }
  }
}, 20);

//==============================
// „Çø„Ç§„Éû„ÉºÈñ¢ÈÄ£ÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ
//==============================

// „Çø„Ç§„Éû„ÉºË°®Á§∫
let timeLeft = 10;
const timerElement = document.createElement("div");
timerElement.style.position = "absolute";
timerElement.style.top = "20px";
timerElement.style.left = "20px";
timerElement.style.color = "red";
timerElement.style.fontSize = "32px";
timerElement.style.fontFamily = "monospace";
timerElement.style.zIndex = "9999";
timerElement.textContent = `ÊÆã„ÇäÊôÇÈñì: ${timeLeft}`;
gameArea.appendChild(timerElement);

// „Ç∞„É≠„Éº„Éê„É´„Çø„Ç§„Éû„ÉºÂ§âÊï∞
let timerInterval = null;

//------------------------------
// „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ôºà3,2,1,STARTÔºâ
//------------------------------
function startCountdown() {
  const countdownEl = document.getElementById("countdown");
  let count = 3;
  countdownEl.innerText = count;

  const countdownTimer = setInterval(() => {
    count--;
    if (count > 0) {
      countdownEl.innerText = count;
    } else if (count === 0) {
      countdownEl.innerText = "START!";
    } else {
      clearInterval(countdownTimer);
      countdownEl.style.display = "none";
      gameStarted = true;

      // ‚òÖ „Ç≤„Éº„É†ÈñãÂßãÂæå„Å´1Âõû„Å†„Åë„Çø„Ç§„Éû„Éº„ÇíËµ∑Âãï
      if (!timerInterval) startGameTimer();
    }
  }, 1000);
}
startCountdown();

//------------------------------
// ÊÆã„ÇäÊôÇÈñì„Çø„Ç§„Éû„Éº
//------------------------------
function startGameTimer() {
  timerInterval = setInterval(() => {
    if (isHit || gameCleared) return;

    // „Çø„Ç§„Éû„Éº„ÇíÊ∏õ„Çâ„Åô
    timeLeft--;

    // Ë°®Á§∫Êõ¥Êñ∞
    timerElement.textContent = `ÊÆã„ÇäÊôÇÈñì: ${timeLeft}`;

    // „Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÂà§ÂÆö
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerInterval = null; // ‚Üê ÂÜçÂÆüË°åÈò≤Ê≠¢
      timeLeft = 0; // ‚Üê Ë°®Á§∫„Çí0„ÅßÊ≠¢„ÇÅ„Çã
      timerElement.textContent = `ÊÆã„ÇäÊôÇÈñì: 0`;

      // „Ç¥„Éº„É´Âá∫Áèæ
      goal.style.display = "block";
      updateGoalPosition();
    }
  }, 1000);
}


//==============================
// ÈöúÂÆ≥Áâ©Èñ¢ÈÄ£
//==============================
let obstacles = [];
const obstacleSpeed = 2;
const obstacleSpawnInterval = 2500; // 2.5Áßí„Åî„Å®„Å´Âá∫Áèæ

// ÈöúÂÆ≥Áâ©ÁîüÊàêÔºàËÉåÊôØÂü∫Ê∫ñ„ÅÆ‰ΩçÁΩÆ„Å´ÁîüÊàêÔºâ
function spawnObstacle() {
  const obstacle = document.createElement("img");
  obstacle.src = "image/obstacle.png";
  obstacle.className = "sprite obstacle";
  obstacle.style.width = "80px";
  obstacle.style.height = "80px";
  obstacle.style.position = "absolute";
  obstacle.style.pointerEvents = "none";
  gameArea.appendChild(obstacle);

  // ËÉåÊôØ‰∏ä„ÅÆÂ∫ßÊ®ôÔºàËÉåÊôØÂü∫Ê∫ñÔºâ
  const startX = -bgX + window.innerWidth + 100; // ËÉåÊôØ‰∏ä„ÅÆÂè≥Á´Ø„Å´Âá∫„Åô
  const startY = Math.random() * (window.innerHeight - 100);

  obstacles.push({
    element: obstacle,
    worldX: startX, // ËÉåÊôØÂü∫Ê∫ñ„Åß„ÅÆX‰ΩçÁΩÆ
    y: startY
  });
}

// ÈöúÂÆ≥Áâ©„ÅÆÊõ¥Êñ∞ÔºàËÉåÊôØ„Å´Âêà„Çè„Åõ„Å¶Âãï„ÅèÔºâ
function updateObstacles() {
  for (let i = obstacles.length - 1; i >= 0; i--) {
    const o = obstacles[i];

    // ËÉåÊôØ‰∏ä„Åß„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
    o.worldX -= obstacleSpeed;

    // ÂÆüÈöõ„ÅÆÁîªÈù¢‰∏ä„Åß„ÅÆÊèèÁîª‰ΩçÁΩÆ„ÇíË®àÁÆó
    const screenX = o.worldX + bgX;
    o.element.style.left = screenX + "px";
    o.element.style.top = o.y + "px";

    // ËÉåÊôØÂ∑¶Á´Ø„Çà„ÇäÂ∑¶„Å´Âá∫„Åü„ÇâÂâäÈô§
    if (screenX < -100) {
      o.element.remove();
      obstacles.splice(i, 1);
      continue;
    }

    // ===== ÂΩì„Åü„ÇäÂà§ÂÆö =====
    const rectO = o.element.getBoundingClientRect();
    const rectP = player.getBoundingClientRect();
    if (
      rectO.left < rectP.right &&
      rectO.right > rectP.left &&
      rectO.top < rectP.bottom &&
      rectO.bottom > rectP.top
    ) {
      // Ë°ùÁ™ÅÂá¶ÁêÜ
      o.element.remove();
      obstacles.splice(i, 1);
      triggerKnockback(); // ‚Üê ÂæåÈÄÄ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âëº„Å≥Âá∫„Åó
    }
  }
}

function triggerKnockback() {
  isHit = true; // ÂæåÈÄÄ‰∏≠„ÅØÊìç‰ΩúÁ¶ÅÊ≠¢
  const knockbackDistance = 100; // ÂæåÈÄÄË∑ùÈõ¢
  const duration = 1000; // „Éü„É™ÁßíÔºà1Áßí„ÅßÂæåÈÄÄÔºâ
  const steps = 50; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂàÜÂâ≤Êï∞
  const movePerStep = knockbackDistance / steps;
  const interval = duration / steps;

  let step = 0;

  const knockbackTimer = setInterval(() => {
    bgX += movePerStep; // ËÉåÊôØ„ÇíÂ∞ë„Åó„Åö„Å§Âè≥„Å∏Âãï„Åã„Åô
    gameArea.style.backgroundPosition = `${bgX}px 0px`;
    step++;

    // ÁµÇ‰∫ÜÂà§ÂÆö
    if (step >= steps) {
      clearInterval(knockbackTimer);
      isHit = false; // Êìç‰ΩúÂÜçÈñã
    }
  }, interval);
}


// ‰∏ÄÂÆöÈñìÈöî„ÅßÈöúÂÆ≥Áâ©„ÇíÂá∫Áèæ„Åï„Åõ„Çã
setInterval(() => {
  if (gameStarted && !isHit) spawnObstacle();
}, obstacleSpawnInterval);


